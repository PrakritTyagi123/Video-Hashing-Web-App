{% extends "base.html" %}
{% block title %}Finished Â· Video Hasher{% endblock %}

{% block body %}
<div class="card shadow-sm">
  <div class="card-body">

    <h3 class="card-title"><i class="fa fa-flag-checkered"></i> Scan complete</h3>

    <div class="mt-3 d-flex gap-2 flex-wrap">
      <a class="btn btn-sm btn-secondary"
         href="{{ url_for('download', jid=jid) }}">
        <i class="fa fa-download"></i> JSON report
      </a>

      <a class="btn btn-sm btn-outline-success"
         href="{{ url_for('csv_export', jid=jid) }}">
        <i class="fa fa-file-csv"></i> CSV
      </a>

      <button class="btn btn-sm btn-outline-info"
              data-bs-toggle="modal" data-bs-target="#qrModal">
        <i class="fa fa-qrcode"></i> Share
      </button>

      <a class="btn btn-sm btn-outline-info"
         href="{{ url_for('gallery', jid=jid) }}">
        <i class="fa fa-th-large"></i> Gallery
      </a>

      <a class="btn btn-sm btn-outline-info ms-auto"
         href="{{ url_for('rescan', jid=jid) }}">
        <i class="fa fa-redo"></i> Scan same folder again
      </a>
    </div>

    {% if job.verify_errors %}
      <div class="alert alert-danger small mt-3">
        <b>Integrity mismatches:</b><br>
        <code class="d-block">
          {% for p in job.verify_errors %}{{ p }}<br>{% endfor %}
        </code>
      </div>
    {% endif %}

    {% if job.duplicates %}
      <hr>
      <h5>Duplicate groups</h5>
      <ul id="dupeList" class="list-group list-group-flush">
        {% for digest, paths in job.duplicates.items() %}
          <li class="list-group-item bg-dark text-light d-flex justify-content-between align-items-center"
              data-hash="{{ digest }}">
            <span class="me-2 text-info">{{ paths[0].name }}</span>
            <small class="text-muted dup-count">
              +{{ paths|length - 1 }} duplicate{{ 's' if (paths|length - 1) > 1 else '' }}
            </small>
            <button class="btn btn-sm btn-outline-light" onclick="showDupes(this)">
              Review
            </button>
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    <a href="{{ url_for('index') }}" class="btn btn-link text-info mt-4">
      <i class="fa fa-rotate-left"></i> New scan
    </a>
  </div>
</div>

<!--Duplicate group modal-->
<div class="modal fade" id="dupeModal"><div class="modal-dialog modal-lg">
  <div class="modal-content bg-dark text-light">

    <div class="modal-header d-flex justify-content-between align-items-center">
      <h5 class="modal-title">Duplicate group</h5>
      <div>
        <button class="btn btn-sm btn-outline-info me-1" onclick="selectAllDupes()">
          Select All
        </button>
        <button class="btn btn-sm btn-outline-info" onclick="deselectAllDupes()">
          Deselect All
        </button>
      </div>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>

    <div class="modal-body d-flex flex-wrap gap-2" id="dupeBody"></div>
  </div>
</div></div>

<!--QR modal-->
<div class="modal fade" id="qrModal"><div class="modal-dialog modal-sm">
  <div class="modal-content bg-dark text-light">
    <div class="modal-header"><h5 class="modal-title">Share link</h5></div>
    <div class="modal-body d-flex justify-content-center">
      <canvas id="qrCanvas"></canvas>
    </div>
  </div>
</div></div>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
  //QR code
  new QRCode(document.getElementById('qrCanvas'),
             location.origin + '/results/{{ jid }}');

  //Show duplicates in modal
  function showDupes(btn) {
    const digest = btn.closest('li').dataset.hash;
    fetch('/dupes/' + digest)
      .then(r => r.json())
      .then(files => {
        const body = document.getElementById('dupeBody');
        body.innerHTML = '';

        files.forEach(f => {
          body.insertAdjacentHTML('beforeend', `
            <div class="card bg-dark text-light" data-path="${f.path}"
                 style="width:200px;margin:1%">
              <video class="dupe-preview"
                     src="/preview/${f.prev}"
                     poster="/thumb/${f.thumb}"
                     muted loop preload="none"
                     style="width:100%;height:120px;object-fit:cover">
              </video>
              <div class="card-body p-2">
                <div class="small"
                     style="word-break:break-all;white-space:normal;"
                     title="${f.name}">${f.name}</div>
                <div class="form-check mt-1">
                  <input class="form-check-input dupe-checkbox" type="checkbox"
                         data-path="${f.path}">
                </div>
                <a href="#" class="small text-info"
                   onclick="reveal('${f.path}');return false;">
                  <i class="fa fa-folder-open"></i> Reveal
                </a>
              </div>
            </div>`);
        });

        body.insertAdjacentHTML('beforeend', `
          <button id="deleteSel" class="btn btn-danger w-100 mt-2">
            Delete selected
          </button>`);

        //Delete selected duplicates
        document.getElementById('deleteSel').onclick = () => {
          const checked = body.querySelectorAll('.dupe-checkbox:checked');
          if (!checked.length) return;
          if (!confirm('Delete ' + checked.length + ' file(s)?')) return;
          const paths = Array.from(checked).map(cb => cb.dataset.path);

          fetch('/delete', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({paths})
          })
          .then(r => r.json())
          .then(({deleted}) => {
            //Remove preview cards
            deleted.forEach(p => {
              const card = body.querySelector(`.card[data-path="${p}"]`);
              if (card) card.remove();
            });
            //Update main list count or remove group
            const listItem = document.querySelector(
              `#dupeList li[data-hash="${digest}"]`);
            const remaining = body.querySelectorAll('.card[data-path]').length;
            if (listItem) {
              if (remaining <= 1) {
                listItem.remove();
                //Close modal if no duplicates left
                bootstrap.Modal.getInstance(document.getElementById('dupeModal')).hide();
              } else {
                listItem.querySelector('.dup-count').textContent =
                  '+' + (remaining - 1) + ' duplicate' +
                  ((remaining - 1) > 1 ? 's' : '');
              }
            }
            toast(`Deleted ${deleted.length} file(s).`, 'danger');
          });
        };

        //Hover play previews
        document.querySelectorAll('.dupe-preview').forEach(v => {
          v.addEventListener('mouseenter', () => v.play());
          v.addEventListener('mouseleave', () => {
            v.pause(); v.currentTime = 0;
          });
        });

        new bootstrap.Modal('#dupeModal').show();
      });
  }

  function selectAllDupes() {
    document.querySelectorAll('.dupe-checkbox').forEach(cb => cb.checked = true);
  }
  function deselectAllDupes() {
    document.querySelectorAll('.dupe-checkbox').forEach(cb => cb.checked = false);
  }
  function reveal(path) {
    fetch('/reveal?path=' + encodeURIComponent(path));
  }
</script>
{% endblock %}
